# "Nataly"

Nataly - client-side фреймворк, основанный на архитехтуре Flux.

Рассмотрим его структуру и способ использования на примере простого приложения, задача которого - осуществить отправку данных из формы на сервер.

## TL, DR
 
Фреймворк реализует 4 класса - Dispatcher, Logger, Store и View. 
  - Dispatcher регистрирует хранилища и оповещать их о действиях. 
  - Logger следит за вызовом методов экземпляра любого класса и оповещает подписчиков об изменении логов.
  - Store может хранить данные и обновлять их при определенных действиях, оповещая при этом подписчиков об обновлении.
  - View может хранить элементы DOM-дерева и запускать слушатели событий (так себе класс, его можно еще чем-нибудь наполнить)



## Точка входа

Точка входа в приложение - [index.js](./src/index.js). Здесь к приложению подключаются несколько модулей, хранилище регистрируется в диспетчере и создаются представления. 

Список подключаемых модулей:
  - `dispatcher` - Диспетчер приложения, созданный в [basicDispatcher.js](./src/basicDispatcher.js). Диспетчер является Singlton'ом, т.е. он существует в приложении в единственном экземпляре;
  
  - `logger` - объект, осуществляющий логгирование, созданный в [basicLogger.js](./src/basicLogger.js);

  - `formStore` - объект, хрянящий данные о форме, созданный в [stores/formStore](./src/stores/formStore.js);

  - `FormView`, LogView - клыссы, экземпляры которых создаются в index.js [basicLogger.js](./src/basicLogger.js);

## Dispatcher

Теперь пойдем в глубь. Первая строчка кода:
  
  ````
  // регистрируем store у диспетчера
  dispatcher.registerStore(formStore);
  ````

Диспетчер приложения - это всего лишь экземпляр [класса Dispatcher](./Nataly/Dispatcher.js) из фреймворка Nataly.  

Диспетчер хранит информацию о зарегестрированных в  приложении хранилищах(atores) и может отправлять действия (actions) для обработки в зарегестрированные хранилища.

Добавение хранилища в диспетчер происходит с помощью метода `registerStore`, а при вызове метода `dispatch` зарегестрированные хранилища оповещаются о создании нового действия.

## FormStore

Мы попрежнему на этой строчке:
  ````
  // регистрируем store у диспетчера
  dispatcher.registerStore(formStore);
  ````
Теперь о formStore. formStore - экземпляр [класса Store](./Nataly/Store.js) из фреймворка Nataly, реализущего хранилище. Хранилище - это объект, хранящий данные, которые могу обновляться, когда диспетчер посылает определенные действия в хранилище. Хранилище может иметь подписчиков. Подписчики - функции,вызываемы при обновлении данных. Механизм подписок реализован с помощью паттерна Observer

Хранилищу при создании задаются начальные данные
  
  ````
  const formStoreData = {
    answerByServer: 'Ответа от сервера еще не было',
  };
  ````
и набор действий, которые имеют право его изменять данные

  ````
  function updateStoreByActions(action) {
    switch (action.type) {
      case SEND_VALUE_TO_SERVER:
        return { ...this.data, answerByServer: action.payload };
      default:
        return null;
    }
  }
  ````

Хранилище реализует метод `update`, который вызывается диспетчером при любом приходящем в него действии. Метод вызывает внутри метод `updateStoreByActions`, созданный при инициализации экземпляра класса. Этот метод обновляет данные, если действие имеет один из указанных указанный типов. Если данные обновились - все подписчики хранилища получают об этом уведомление.

Подписчики - функции, добавляемые в хранилище с помощью метода `addSubscriber`.

Также мы при создании хранилища сказали логгеру следить за ним, об этом позже.

## View

Мы зарегистрировали хранилище, теперь переходим ко второй строчке:

  ````
  // создаем view для формы
  const formView = new FormView();
  ````
FormView - экземпляр [класса View](./Nataly/View.js) из фреймворка Nataly, реализущего представление. Предстваление - объект, хранящий информацию об элементах интерфеса и знающий, какое действие запустить при определенных событиях (действия пользователя, например).

в FormView мы объявили функции-слушатели событий, которые инициализируются статичным методом базового класса View. Мы указали, что при нажатии кнопки нужно запустить создатель дейтсвий (action-creator) sendValueToServer.

Action-creator - это функция, которая создает действия и отправляет их в диспетчер,используя метод dispatch. У каждого действия есть тип - строка, однозначно идентифицирующая это действие.  

Далее в коде `index.js` мы связываем formView с formStore с помощью метода `connectToStore`. Метод вызывает функцию добавления подписчика в store, передавая в качестве подписчика функцию обновления данных во View.


После создания экземпляра класса view мы сказали логгеру следить за ним. Об этом далее.

## Logger

При создании хранилища, диспетчера и view мы сказали экземпляру класса логгер следить за ними. Для этого мы использовали метод `lookFor`. Этот метод декорирует все методы экземпляра класса, предоставленного ему, добавляя перед вызовом этих методов собственную функцию - `saveLog`. Logger, как и Store, может иметь подписчиков.

Благодаря тому, что logger может иметь собственных подписчиков, мы смогли создать logView, и, аналогично тому, как подписывались на Store, подписать его на события логгирования.